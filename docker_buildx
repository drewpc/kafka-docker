#!/bin/bash -e

EXTRA_BUILDX_ARGS=$@
CACHE_LOCATION="/tmp/docker-cache"
PLATFORMS="linux/amd64,linux/arm64"

echo "TRAVIS_CPU_ARCH: $TRAVIS_CPU_ARCH"

if [[ "${EXTRA_BUILDX_ARGS}" == *"--load"* ]]; then
    # We have to use the current architecture only when loading the image to run tests, so let's
    # pull FROM the multi-arch build that happened previously
    PLATFORMS="linux/amd64"
    CACHE="--cache-from=type=local,src=${CACHE_LOCATION}"
elif [[ "${EXTRA_BUILDX_ARGS}" == *"--push"* ]]; then
    # Push ALL architectures FROM the multi-arch build cache that happened previously
    CACHE="--cache-from=type=local,src=${CACHE_LOCATION}"
else
    # This is the multi-arch build that we should cache and use later
    CACHE="--cache-to=type=local,dest=${CACHE_LOCATION}"
fi

docker buildx build \
    $CACHE \
    --platform "${PLATFORMS}" \
    --progress=plain \
    --build-arg kafka_version=$KAFKA_VERSION \
    --build-arg scala_version=$TRAVIS_SCALA_VERSION \
    --build-arg vcs_ref=$TRAVIS_COMMIT \
    --build-arg build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
    -t drewpc/kafka \
    $EXTRA_BUILDX_ARGS \
    .