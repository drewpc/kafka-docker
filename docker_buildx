#!/bin/bash -ex

EXTRA_BUILDX_ARGS=$@

CACHE_LOCATION="type=local,dest=/tmp/docker-cache"
if [[ "${EXTRA_BUILDX_ARGS}" == "" ]]; then
    CACHE="--cache-to=${CACHE_LOCATION}"
else
    CACHE="--cache-from=${CACHE_LOCATION}"
fi

if [[ "${EXTRA_BUILDX_ARGS}" == *"--load"* ]]; then
    PLATFORMS="linux/amd64"
else
    PLATFORMS="linux/amd64,linux/arm64"
fi

docker buildx build \
    $CACHE \
    --platform "${PLATFORMS}" \
    --progress=plain \
    --build-arg kafka_version=$KAFKA_VERSION \
    --build-arg scala_version=$TRAVIS_SCALA_VERSION \
    --build-arg vcs_ref=$TRAVIS_COMMIT \
    --build-arg build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
    -t drewpc/kafka \
    $EXTRA_BUILDX_ARGS \
    .